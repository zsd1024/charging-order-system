name: Deploy to Tencent Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Deploy
        uses: appleboy/ssh-action@master
        with:
          # 1. 这里改成了和你截图一致的名字
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          # 2. 这里改成了 key 模式，对应你的 SSH_PRIVATE_KEY
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 进入项目目录
            cd /home/ubuntu/charging-order-system
            
            # 拉取最新代码
            echo "==== 开始拉取代码 ===="
            git pull origin main
            
            # 停止并删除旧容器
            echo "==== 停止旧容器 ===="
            sudo docker stop charging-app || true
            sudo docker rm charging-app || true
            
            # 删除旧镜像 (清理空间)
            sudo docker rmi charging-app-image || true
            
            # 构建新镜像
            echo "==== 构建新镜像 ===="
            sudo docker build -t charging-app-image .
            
            # 启动新容器
            echo "==== 启动新容器 ===="
            sudo docker run -d \
              --name charging-app \
              -p 8080:8080 \
              --network charging-net \
              -e TZ=Asia/Shanghai \
              charging-app-image
            
            echo "==== 部署成功！ ===="