name: Deploy to Tencent Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ▼▼▼▼ 新增了这一行，允许脚本运行 30 分钟不超时 ▼▼▼▼
          command_timeout: 30m
          script: |
            cd /home/ubuntu/charging-order-system
            
            echo "==== 拉取代码 ===="
            git pull origin main
            
            echo "==== 停止旧容器 ===="
            sudo docker stop charging-app || true
            sudo docker rm charging-app || true
            sudo docker rmi charging-app-image || true
            
            echo "==== 开始构建 (这一步较慢，请耐心等待) ===="
            # 注意：第一次构建会很慢，下载完依赖后，下次就快了
            sudo docker build -t charging-app-image .
            
            echo "==== 启动容器 ===="
            sudo docker run -d \
              --name charging-app \
              -p 8080:8080 \
              --network charging-net \
              -e TZ=Asia/Shanghai \
              charging-app-image
            
            echo "==== 部署成功！ ===="