name: Deploy to Tencent Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PWD }}
          script: |
            # 1. 进入项目目录 (请确认你的项目在服务器的这个位置)
            cd /home/ubuntu/charging-order-system
            
            # 2. 让服务器自己拉取最新代码 (这比传输文件快得多)
            echo "==== 开始拉取代码 ===="
            git pull origin main
            
            # 3. 停止并删除旧容器
            echo "==== 停止旧容器 ===="
            sudo docker stop charging-app || true
            sudo docker rm charging-app || true
            
            # 4. 删除旧镜像 (可选，为了节省空间)
            sudo docker rmi charging-app-image || true
            
            # 5. 构建新镜像
            echo "==== 构建新镜像 ===="
            sudo docker build -t charging-app-image .
            
            # 6. 启动新容器
            echo "==== 启动新容器 ===="
            sudo docker run -d \
              --name charging-app \
              -p 8080:8080 \
              --network charging-net \
              -e TZ=Asia/Shanghai \
              charging-app-image
            
            echo "==== 部署成功！ ===="